{"version":3,"sources":["uni-app:///main.js","webpack:///C:/Users/chejun/Desktop/woerp/pages/checkout/checkout.vue?fdae","webpack:///C:/Users/chejun/Desktop/woerp/pages/checkout/checkout.vue?f97f","webpack:///C:/Users/chejun/Desktop/woerp/pages/checkout/checkout.vue?b0f5","webpack:///C:/Users/chejun/Desktop/woerp/pages/checkout/checkout.vue?d6c5","uni-app:///pages/checkout/checkout.vue","webpack:///C:/Users/chejun/Desktop/woerp/pages/checkout/checkout.vue?8bf9","webpack:///C:/Users/chejun/Desktop/woerp/pages/checkout/checkout.vue?5662"],"names":["wx","__webpack_require_UNI_MP_PLUGIN__","__webpack_require__","createPage","Page","data","cart","selectedDept","selectedIo","departments","ioTypes","value","label","canvasW","canvasH","_canvasNode","ctx","last","isDrawing","hasStroke","signConfirmed","signImage","drawTimer","pendingDraw","rafId","pointQueue","onLoad","onReady","setTimeout","methods","formatTime","initCanvas","console","uni","in","select","fields","node","size","exec","canvas","c","onStart","x","y","onMove","onEnd","clearTimeout","cancelCheckout","title","content","success","clearSign","captureSignature","canvasId","fileType","quality","resolve","fail","reject","confirmSign","uiUtils","img","confirmSettle","store","k","signAt","id","code","name","type","quantity","time","department","ioType","url","importRecords","_isH5Ctx"],"mappings":";;;;;;;;;;;;;AAAA;AAGA;AACA;AAHA;AACAA,EAAE,CAACC,iCAAiC,GAAGC,mBAAmB;AAG1DC,UAAU,CAACC,iBAAI,CAAC,C;;;;;;;;;;;;;ACLhB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAiI;AACjI;AAC4D;AACL;AACsC;;;AAG7F;AACoL;AACpL,gBAAgB,6LAAU;AAC1B,EAAE,8EAAM;AACR,EAAE,+FAAM;AACR,EAAE,wGAAe;AACjB;AACA;AACA;AACA;AACA;AACA,EAAE,mGAAU;AACZ;AACA;;AAEA;AACe,gF;;;;;;;;;;;;ACvBf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;;;;;ACAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAM;AACN;AACA;AACA;AACA;AACA,OAAO;AACP;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;AC1CA;AAAA;AAAA;AAAA;AAA6qB,CAAgB,ksBAAG,EAAC,C;;;;;;;;;;;;;;;;;;;;;AC+DjsB;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEA;EAAA;EACA;EACA;EACA;EACA;AACA;AAAA,eAEA;EACAC;IACA;MACAC;MACAC;MACAC;MACAC;MACAC,UACA;QAAAC;QAAAC;MAAA,GACA;QAAAD;QAAAC;MAAA,GACA;QAAAD;QAAAC;MAAA,GACA;QAAAD;QAAAC;MAAA,GACA;QAAAD;QAAAC;MAAA,GACA;QAAAD;QAAAC;MAAA,GACA;QAAAD;QAAAC;MAAA,GACA;QAAAD;QAAAC;MAAA,GACA;QAAAD;QAAAC;MAAA,EACA;MAEAC;MACAC;MACAC;MACAC;MACAC;MACAC;MACAC;MACAC;MACAC;MACAC;MAAA;MACAC;MAAA;MACAC;MAAA;MACAC;IACA;EACA;EACAC;IACA;EACA;EACAC;IAAA;IACA;IACAC;MACA;IACA;EACA;EACAC;IACAC;MACA;MACA;MACA;IACA;IAEAC;MAAA;MACA;QACA;QACA;UACAC;UACA;QACA;QAEA;QACA;QACA;QACA;QACA;;QAsCA;QACAC,0BACAC,SACAC,sBACAC;UAAAC;UAAAC;QAAA,GACAC;UACA;UACA;YACA;YACA;YACAC;YACAA;YACA;YACAxB;YACA;YACAA;YACAA;YACAA;YACAA;YACAA;YACA;YACA;UACA;YACA;YACA;YACAyB;YACAA;YACAA;YACAA;YACA;UACA;QACA;MAcA;QACAT;QACA;MACA;IACA;IAEAU;MACA;QACAV;QACA;MACA;;MAEA;MACA;MACA;MAEA;MACA;MACA;MACA;MACA;QAAAW;QAAAC;MAAA;MACA;MAEA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;MACA;QACA;QACA;QACA;MACA;IACA;IAEAC;MAAA;MACA;MACA;MACA;MACA;;MAEA;MACA;MACA;MACA;;MAEA;MACA;;MAEA;MACA;MACA;QAAAF;QAAAC;MAAA;MACA;QACA;UACA;UACA;UACA;UACA;UACA;UACA;QACA;QACA;UACA;UACA;UACA;YACA;YACA;YACA;YACA;cACA;cACA;cACA;cACA;YACA;cACA;cACA;YACA;YACA;cAAAD;cAAAC;YAAA;UACA;UACA;UACA;YACA;UACA;QACA;MACA;MACA;IACA;IAEAE;MACA;MACA;;MAEA;MACA;QACAC;QACA;MACA;MACA;MACA;MACA;;MAEA;MACA;QACA;UACA;QACA;UACA;UACA;UACA;QACA;MACA;IACA;IAEAC;MACAf;QACAgB;QACAC;QACAC;UACA;YACAlB;UACA;QACA;MACA;IACA;IAEAmB;MACA;MACA;MACA;MACA;MACA;MACA;QACA;UACA;UACA;QACA;UACA;UACA;UACA;QACA;MACA;IACA;IAEAC;MAAA;MACA;QAaA;QACA;UACA;YACA;YACA;UACA;YACArB;UACA;QACA;;QAEA;QACAC;UACAqB;UACAC;UACAC;UACAL;YACAnB;YACAyB;UACA;UACAC;YACA1B;YACA2B;UACA;QACA;MAaA;IACA;IAEAC;MAAA;MAAA;QAAA;QAAA;UAAA;YAAA;cAAA;gBAAA,IACA;kBAAA;kBAAA;gBAAA;gBACAC;gBAAA;cAAA;gBAAA;gBAAA;gBAAA,OAIA;cAAA;gBAAAC;gBACA;gBACA;gBACAD;gBAAA;gBAAA;cAAA;gBAAA;gBAAA;gBAEAA;cAAA;cAAA;gBAAA;YAAA;UAAA;QAAA;MAAA;IAEA;IAEAE;MAAA;MAAA;QAAA;QAAA;UAAA;YAAA;cAAA;gBAAA,IACA;kBAAA;kBAAA;gBAAA;gBACAF;gBAAA;cAAA;gBAAA,IAGA;kBAAA;kBAAA;gBAAA;gBACAA;gBAAA;cAAA;gBAAA,IAKA;kBAAA;kBAAA;gBAAA;gBAAA;gBAAA;gBAAA,OAEA;cAAA;gBAAA;gBAAA;gBAAA;cAAA;gBAAA;gBAAA;cAAA;gBAIAG;gBACAC;gBACA;gBACAC;gBAEA;kBACAF;oBACAG;oBACAC;oBACAC;oBACAC;oBACAC;oBACAC;oBACAC;oBACAC;oBACAR;oBACA7C;kBACA;gBACA;gBAEAY;gBACAA;gBAEA4B;gBAEAjC;kBACAK;oBAAA0C;kBAAA;gBACA;cAAA;cAAA;gBAAA;YAAA;UAAA;QAAA;MAAA;IACA;IAEAC;MACA;MACA3C;QACAgB;QACAC;QACAC;UACA;YACA;YACAU;UACA;QACA;MACA;IACA;IAEAgB;MACA;MACA;IACA;EACA;AACA;AAAA,2B;;;;;;;;;;;;;ACjfA;AAAA;AAAA;AAAA;AAA4yC,CAAgB,ywCAAG,EAAC,C;;;;;;;;;;;ACAh0C;AACA,OAAO,KAAU,EAAE,kBAKd","file":"pages/checkout/checkout.js","sourcesContent":["import 'uni-pages';\n// @ts-ignore\nwx.__webpack_require_UNI_MP_PLUGIN__ = __webpack_require__;\nimport Vue from 'vue'\nimport Page from './pages/checkout/checkout.vue'\ncreatePage(Page)","import { render, staticRenderFns, recyclableRender, components } from \"./checkout.vue?vue&type=template&id=a037f574&scoped=true&\"\nvar renderjs\nimport script from \"./checkout.vue?vue&type=script&lang=js&\"\nexport * from \"./checkout.vue?vue&type=script&lang=js&\"\nimport style0 from \"./checkout.vue?vue&type=style&index=0&id=a037f574&lang=scss&scoped=true&\"\n\n\n/* normalize component */\nimport normalizer from \"!D:\\\\Program Files\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\vue-cli-plugin-uni\\\\packages\\\\vue-loader\\\\lib\\\\runtime\\\\componentNormalizer.js\"\nvar component = normalizer(\n  script,\n  render,\n  staticRenderFns,\n  false,\n  null,\n  \"a037f574\",\n  null,\n  false,\n  components,\n  renderjs\n)\n\ncomponent.options.__file = \"pages/checkout/checkout.vue\"\nexport default component.exports","export * from \"-!D:\\\\Program Files\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\vue-cli-plugin-uni\\\\packages\\\\vue-loader\\\\lib\\\\loaders\\\\templateLoader.js??vue-loader-options!D:\\\\Program Files\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\vue-cli-plugin-uni\\\\packages\\\\webpack-preprocess-loader\\\\index.js??ref--17-0!D:\\\\Program Files\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\webpack-uni-mp-loader\\\\lib\\\\template.js!D:\\\\Program Files\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\vue-cli-plugin-uni\\\\packages\\\\webpack-uni-app-loader\\\\page-meta.js!D:\\\\Program Files\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\vue-cli-plugin-uni\\\\packages\\\\vue-loader\\\\lib\\\\index.js??vue-loader-options!D:\\\\Program Files\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\webpack-uni-mp-loader\\\\lib\\\\style.js!./checkout.vue?vue&type=template&id=a037f574&scoped=true&\"","var components\nvar render = function () {\n  var _vm = this\n  var _h = _vm.$createElement\n  var _c = _vm._self._c || _h\n  var l0 = _vm.__map(_vm.cart, function (it, __i0__) {\n    var $orig = _vm.__get_orig(it)\n    var m0 = _vm.formatTime(it.timestamp)\n    return {\n      $orig: $orig,\n      m0: m0,\n    }\n  })\n  var g0 = _vm.cart.length\n  if (!_vm._isMounted) {\n    _vm.e0 = function ($event, dept) {\n      var _temp = arguments[arguments.length - 1].currentTarget.dataset,\n        _temp2 = _temp.eventParams || _temp[\"event-params\"],\n        dept = _temp2.dept\n      var _temp, _temp2\n      _vm.selectedDept = dept\n    }\n    _vm.e1 = function ($event, opt) {\n      var _temp3 = arguments[arguments.length - 1].currentTarget.dataset,\n        _temp4 = _temp3.eventParams || _temp3[\"event-params\"],\n        opt = _temp4.opt\n      var _temp3, _temp4\n      _vm.selectedIo = opt.value\n    }\n  }\n  _vm.$mp.data = Object.assign(\n    {},\n    {\n      $root: {\n        l0: l0,\n        g0: g0,\n      },\n    }\n  )\n}\nvar recyclableRender = false\nvar staticRenderFns = []\nrender._withStripped = true\n\nexport { render, staticRenderFns, recyclableRender, components }","import mod from \"-!D:\\\\Program Files\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\babel-loader\\\\lib\\\\index.js!D:\\\\Program Files\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\vue-cli-plugin-uni\\\\packages\\\\webpack-preprocess-loader\\\\index.js??ref--13-1!D:\\\\Program Files\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\webpack-uni-mp-loader\\\\lib\\\\script.js!D:\\\\Program Files\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\vue-cli-plugin-uni\\\\packages\\\\vue-loader\\\\lib\\\\index.js??vue-loader-options!D:\\\\Program Files\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\webpack-uni-mp-loader\\\\lib\\\\style.js!./checkout.vue?vue&type=script&lang=js&\"; export default mod; export * from \"-!D:\\\\Program Files\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\babel-loader\\\\lib\\\\index.js!D:\\\\Program Files\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\vue-cli-plugin-uni\\\\packages\\\\webpack-preprocess-loader\\\\index.js??ref--13-1!D:\\\\Program Files\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\webpack-uni-mp-loader\\\\lib\\\\script.js!D:\\\\Program Files\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\vue-cli-plugin-uni\\\\packages\\\\vue-loader\\\\lib\\\\index.js??vue-loader-options!D:\\\\Program Files\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\webpack-uni-mp-loader\\\\lib\\\\style.js!./checkout.vue?vue&type=script&lang=js&\"","<template>\n  <view class=\"page\">\n    <view class=\"hd\">出入库结算</view>\n\n    <scroll-view scroll-y enable-flex class=\"list\">\n      <view class=\"item\" v-for=\"it in cart\" :key=\"it.id\">\n        <view class=\"title\">{{ it.materialCode }} - {{ it.materialName }}</view>\n        <view class=\"meta\">\n          <text class=\"tag\" :class=\"it.type\">{{ it.type==='inbound'?'入库':'出库' }}</text>\n          <text>数量：{{ it.quantity }}</text>\n          <text>{{ formatTime(it.timestamp) }}</text>\n        </view>\n      </view>\n      <view v-if=\"!cart.length\" class=\"empty\">\n        <u-empty mode=\"list\" text=\"清单为空\" />\n      </view>\n    </scroll-view>\n\n    <!-- 部门选择 -->\n    <view class=\"section-title\">选择部门</view>\n    <scroll-view scroll-x enable-flex class=\"h-scroll chips\">\n      <label v-for=\"dept in departments\" :key=\"dept\" class=\"chip\" :class=\"{active: dept===selectedDept}\">\n        <radio :value=\"dept\" :checked=\"dept===selectedDept\" @click=\"selectedDept=dept\" /> {{ dept }}\n      </label>\n    </scroll-view>\n\n    <!-- 出入库类别选择 -->\n    <view class=\"section-title\">出入库类别</view>\n    <scroll-view scroll-x enable-flex class=\"h-scroll chips\">\n      <label v-for=\"opt in ioTypes\" :key=\"opt.value\" class=\"chip\" :class=\"{active: opt.value===selectedIo}\">\n        <radio :value=\"opt.value\" :checked=\"opt.value===selectedIo\" @click=\"selectedIo=opt.value\" /> {{ opt.label }}\n      </label>\n    </scroll-view>\n\n    <!-- 签字确认区域 -->\n    <view class=\"section-title\">签字确认</view>\n    <view class=\"sign-wrap\">\n      <canvas \n        id=\"signCanvas\" \n        type=\"2d\"\n        class=\"sign-canvas\"\n        :style=\"{ width: canvasW + 'px', height: canvasH + 'px' }\"\n        @touchstart=\"onStart\"\n        @touchmove=\"onMove\"\n        @touchend=\"onEnd\"\n      />\n      <view class=\"sign-tips\" v-if=\"!hasStroke\">请在上方区域签名</view>\n      <view class=\"sign-status\" v-if=\"signConfirmed\">✓ 签名已确认</view>\n    </view>\n\n    <!-- 操作按钮 -->\n    <view class=\"footer\">\n      <view class=\"btn-row\">\n        <view class=\"action-btn btn-cancel\" @click=\"cancelCheckout\">取消</view>\n        <view class=\"action-btn btn-clear\" @click=\"clearSign\">清除签名</view>\n        <view class=\"action-btn btn-confirm\" @click=\"confirmSign\" :class=\"!hasStroke ? 'btn-disabled' : ''\">确认签名</view>\n        <view class=\"action-btn btn-settle\" @click=\"confirmSettle\" :class=\"!signConfirmed ? 'btn-disabled' : ''\">确认结算</view>\n      </view>\n    </view>\n  </view>\n</template>\n\n<script>\nimport { uiUtils } from '@/common/util.js'\n\nfunction dateKey(d = new Date()) {\n  const y = d.getFullYear()\n  const m = String(d.getMonth() + 1).padStart(2, '0')\n  const day = String(d.getDate()).padStart(2, '0')\n  return `${y}-${m}-${day}`\n}\n\nexport default {\n  data(){\n    return {\n      cart: [],\n      selectedDept: '配料',\n      selectedIo: 'inbound_purchase',\n      departments: ['配料','制片','卷绕','封装','注液','切边','包装','PACK','技术部'],\n      ioTypes: [\n        {value:'inbound_purchase',label:'采购入库'},\n        {value:'return_purchase',label:'采购退货'},\n        {value:'line_return',label:'产线退仓'},\n        {value:'prod_issue',label:'生产领料'},\n        {value:'batch_out',label:'批次出库'},\n        {value:'over_out',label:'超领出库'},\n        {value:'replenish_out',label:'补料出库'},\n        {value:'mix_issue',label:'制料领料'},\n        {value:'aux_out',label:'辅料出库'}\n      ],\n      \n      canvasW: 0,\n      canvasH: 0,\n      _canvasNode: null,\n      ctx: null,\n      last: null,\n      isDrawing: false,\n      hasStroke: false,\n      signConfirmed: false,\n      signImage: '',\n      drawTimer: null,        // 绘制防抖定时器（旧方案保留）\n      pendingDraw: false,     // 是否有待绘制的内容（旧方案保留）\n      rafId: null,            // requestAnimationFrame ID（避免以 _ 开头影响代理）\n      pointQueue: []          // 待绘制的点队列（避免以 _ 开头影响代理）\n    }\n  },\n  onLoad() {\n    this.cart = uni.getStorageSync('cartList') || []\n  },\n  onReady() {\n    // 延迟初始化 Canvas，确保页面完全加载\n    setTimeout(() => {\n      this.initCanvas()\n    }, 100)\n  },\n  methods:{\n    formatTime(timestamp) {\n      if (!timestamp) return ''\n      const date = new Date(timestamp)\n      return date.toLocaleString()\n    },\n\n    initCanvas() {\n      try {\n        const sys = uni.getWindowInfo()\n        if (!sys || !sys.windowWidth) {\n          console.warn('Failed to get window info')\n          return\n        }\n        \n        const w = sys.windowWidth - 32\n        // 扩大签字区域高度，从25%增加到35%\n        const h = Math.floor(sys.windowHeight * 0.35)\n        this.canvasW = w\n        this.canvasH = h\n\n      // #ifdef H5\n      uni.createSelectorQuery()\n        .in(this)\n        .select('#signCanvas')\n        .fields({ node: true, size: true })\n        .exec(res => {\n          const canvas = res && res[0] && res[0].node\n          if (canvas && canvas.getContext) {\n            const dpr = sys.pixelRatio || 1\n            canvas.width = w * dpr\n            canvas.height = h * dpr\n            const ctx = canvas.getContext('2d')\n            ctx.scale(dpr, dpr)\n            // 优化画笔设置以改善字迹连续性\n            ctx.lineWidth = 3              // 稍微减小线宽，提高精度\n            ctx.strokeStyle = '#000'       // 使用更深的黑色\n            ctx.lineCap = 'round'\n            ctx.lineJoin = 'round'\n            ctx.globalCompositeOperation = 'source-over'\n            // 启用抗锯齿和平滑处理\n            ctx.imageSmoothingEnabled = true\n            ctx.imageSmoothingQuality = 'high'\n            this._canvasNode = canvas\n            this.ctx = ctx\n          } else {\n            const c = uni.createCanvasContext('signCanvas', this)\n            c.setStrokeStyle('#111')\n            c.setLineWidth(3)\n            c.setLineCap('round')\n            c.setLineJoin('round')\n            this.ctx = c\n          }\n        })\n      // #endif\n\n      // #ifdef MP-WEIXIN\n      // 微信小程序使用Canvas 2D接口\n      uni.createSelectorQuery()\n        .in(this)\n        .select('#signCanvas')\n        .fields({ node: true, size: true })\n        .exec(res => {\n          const canvas = res && res[0] && res[0].node\n          if (canvas && canvas.getContext) {\n            // 使用Canvas 2D接口\n            const dpr = sys.pixelRatio || 1\n            canvas.width = w * dpr\n            canvas.height = h * dpr\n            const ctx = canvas.getContext('2d')\n            ctx.scale(dpr, dpr)\n            // 优化画笔设置\n            ctx.lineWidth = 3\n            ctx.strokeStyle = '#000'\n            ctx.lineCap = 'round'\n            ctx.lineJoin = 'round'\n            ctx.globalCompositeOperation = 'source-over'\n            this._canvasNode = canvas\n            this.ctx = ctx\n          } else {\n            // 降级到旧接口\n            const c = uni.createCanvasContext('signCanvas', this)\n            c.setStrokeStyle('#000')\n            c.setLineWidth(3)\n            c.setLineCap('round')\n            c.setLineJoin('round')\n            this.ctx = c\n          }\n        })\n      // #endif\n      \n      // #ifdef APP-PLUS\n      // App端的canvas处理\n      const c = uni.createCanvasContext('signCanvas', this)\n      c.setStrokeStyle('#000')  // 使用更深的黑色\n      c.setLineWidth(3)         // 稍微减小线宽，提高精度\n      c.setLineCap('round')\n      c.setLineJoin('round')\n      // App端也移除 setGlobalCompositeOperation 以保持一致性\n      this.ctx = c\n      // #endif\n      \n      } catch (error) {\n        console.error('Canvas initialization failed:', error)\n        this.ctx = null\n      }\n    },\n\n    onStart(e) {\n      if (!this.ctx) {\n        console.warn('Canvas context not initialized')\n        return\n      }\n      \n      // 初始化逐帧队列与状态\n      if (!Array.isArray(this.pointQueue)) this.pointQueue = []\n      this.rafId = null\n\n      this.signConfirmed = false\n      const p = e.touches && e.touches[0] ? e.touches[0] : {}\n      const x = p.x || p.clientX || 0\n      const y = p.y || p.clientY || 0\n      this.last = { x, y }\n      this.isDrawing = true\n\n      if (this._isH5Ctx()) {\n        this.ctx.beginPath()\n        this.ctx.moveTo(x, y)\n        // 在起始点画一个小点，确保单点也能显示\n        this.ctx.arc(x, y, 1, 0, 2 * Math.PI)\n        this.ctx.fill()\n        this.ctx.beginPath()\n        this.ctx.moveTo(x, y)\n      } else {\n        this.ctx.beginPath()\n        this.ctx.moveTo(x, y)\n        this.ctx.draw(true)\n      }\n    },\n\n    onMove(e) {\n      if (!this.last || !this.ctx || !this.isDrawing) return\n      const p = e.touches && e.touches[0] ? e.touches[0] : {}\n      const x = p.x || p.clientX || 0\n      const y = p.y || p.clientY || 0\n\n      // 计算距离，降低阈值以提高流畅性\n      const dx = x - this.last.x\n      const dy = y - this.last.y\n      const distance = Math.sqrt(dx * dx + dy * dy)\n      \n      // 进一步降低距离阈值，确保连续性，同时避免过密计算\n      if (distance < 0.5) return\n\n      // 采用逐帧绘制：收集点，按帧绘制，减少频繁 stroke/beginPath\n      if (!Array.isArray(this.pointQueue)) this.pointQueue = []\n      this.pointQueue.push({ x, y })\n      if (!this.rafId) {\n        const raf = (cb) => {\n          // H5 优先使用 window.requestAnimationFrame\n          if (typeof window !== 'undefined' && window.requestAnimationFrame) return window.requestAnimationFrame(cb)\n          // 微信 Canvas 2D 对象可能支持 requestAnimationFrame\n          if (this._canvasNode && typeof this._canvasNode.requestAnimationFrame === 'function') return this._canvasNode.requestAnimationFrame(cb)\n          // 其他环境降级\n          return setTimeout(cb, 16)\n        }\n        this.rafId = raf(() => {\n          this.rafId = null\n          // 批量消费队列\n          while (this.pointQueue.length) {\n            const pt = this.pointQueue.shift()\n            const midX = (this.last.x + pt.x) / 2\n            const midY = (this.last.y + pt.y) / 2\n            if (this._isH5Ctx()) {\n              this.ctx.quadraticCurveTo(this.last.x, this.last.y, midX, midY)\n              this.ctx.stroke()\n              this.ctx.beginPath()\n              this.ctx.moveTo(midX, midY)\n            } else {\n              this.ctx.lineTo(pt.x, pt.y)\n              this.ctx.stroke()\n            }\n            this.last = { x: pt.x, y: pt.y }\n          }\n          // 小程序端提交一次绘制\n          if (!this._isH5Ctx()) {\n            this.ctx.draw(true)\n          }\n        })\n      }\n      this.hasStroke = true\n    },\n\n    onEnd() { \n      this.last = null\n      this.isDrawing = false\n      \n      // 清理防抖定时器\n      if (this.drawTimer) {\n        clearTimeout(this.drawTimer)\n        this.drawTimer = null\n      }\n      // 清理逐帧队列\n      this.pointQueue = []\n      this.rafId = null\n      \n      // 结束绘制时，确保路径完整\n      if (this.ctx) {\n        if (this._isH5Ctx()) {\n          this.ctx.stroke()\n        } else {\n          // 小程序端确保最后的绘制被提交\n          this.ctx.draw(true)\n          this.pendingDraw = false\n        }\n      }\n    },\n\n    cancelCheckout() {\n      uni.showModal({\n        title: '确认取消',\n        content: '确定要取消当前结算吗？',\n        success: (res) => {\n          if (res.confirm) {\n            uni.navigateBack()\n          }\n        }\n      })\n    },\n\n    clearSign() {\n      this.hasStroke = false\n      this.signConfirmed = false\n      this.signImage = ''\n      this.isDrawing = false\n      this.last = null\n      if (this.ctx) {\n        if (this._isH5Ctx()) {\n          // Canvas 2D接口\n          this.ctx.clearRect(0, 0, this.canvasW, this.canvasH)\n        } else {\n          // 旧版接口\n          this.ctx.clearRect(0, 0, this.canvasW, this.canvasH)\n          this.ctx.draw()\n        }\n      }\n    },\n\n    captureSignature() {\n      return new Promise((resolve, reject) => {\n        // #ifdef H5\n        if (this._canvasNode && this._canvasNode.toDataURL) {\n          try {\n            const dataUrl = this._canvasNode.toDataURL('image/png')\n            return resolve(dataUrl)\n          } catch (e) {\n            return reject(e)\n          }\n        }\n        // #endif\n\n        // #ifdef MP-WEIXIN\n        // 微信小程序Canvas 2D接口导出\n        if (this._canvasNode && this._canvasNode.toDataURL) {\n          try {\n            const dataUrl = this._canvasNode.toDataURL('image/png')\n            return resolve(dataUrl)\n          } catch (e) {\n            console.error('Canvas 2D导出失败，降级到旧接口:', e)\n          }\n        }\n        \n        // 降级到旧版接口\n        uni.canvasToTempFilePath({\n          canvasId: 'signCanvas',\n          fileType: 'png',\n          quality: 1,\n          success: res => {\n            console.log('微信小程序签名导出成功:', res.tempFilePath)\n            resolve(res.tempFilePath)\n          },\n          fail: err => {\n            console.error('微信小程序签名导出失败:', err)\n            reject(err)\n          }\n        }, this)\n        // #endif\n        \n        // #ifdef APP-PLUS\n        // App端的canvas导出\n        uni.canvasToTempFilePath({\n          canvasId: 'signCanvas',\n          fileType: 'png',\n          quality: 1,\n          success: res => resolve(res.tempFilePath),\n          fail: err => reject(err)\n        }, this)\n        // #endif\n      })\n    },\n\n    async confirmSign() {\n      if (!this.hasStroke) {\n        uiUtils.showToast('请先签名')\n        return\n      }\n      try {\n        const img = await this.captureSignature()\n        this.signImage = img\n        this.signConfirmed = true\n        uiUtils.showSuccess('签名已确认')\n      } catch (e) {\n        uiUtils.showError('导出签名失败')\n      }\n    },\n\n    async confirmSettle() {\n      if (!this.cart.length) {\n        uiUtils.showToast('清单为空')\n        return\n      }\n      if (!this.signConfirmed) {\n        uiUtils.showToast('请先确认签名')\n        return\n      }\n\n      // 双保险：若 signImage 还未生成，再生成一次\n      if (!this.signImage) {\n        try { \n          this.signImage = await this.captureSignature() \n        } catch(e){}\n      }\n\n      const store = uni.getStorageSync('recordsByDate') || {}\n      const k = dateKey()\n      if (!store[k]) store[k] = []\n      const signAt = new Date().toLocaleString()\n\n      this.cart.forEach(i => {\n        store[k].unshift({\n          id: i.id,\n          code: i.materialCode,\n          name: i.materialName,\n          type: i.type,\n          quantity: i.quantity,\n          time: this.formatTime(i.timestamp),\n          department: this.selectedDept,\n          ioType: this.selectedIo,\n          signAt,\n          signImage: this.signImage\n        })\n      })\n      \n      uni.setStorageSync('recordsByDate', store)\n      uni.removeStorageSync('cartList')\n      \n      uiUtils.showSuccess('结算完成')\n      \n      setTimeout(() => {\n        uni.reLaunch({ url: '/pages/material/index' })\n      }, 1500)\n    },\n\n    importRecords() {\n      // 模拟导入记录功能\n      uni.showModal({\n        title: '导入记录',\n        content: '是否要导入历史记录？',\n        success: (res) => {\n          if (res.confirm) {\n            // 这里可以实现实际的导入逻辑\n            uiUtils.showSuccess('导入成功')\n          }\n        }\n      })\n    },\n\n    _isH5Ctx() {\n      // 仅在存在真实 Canvas 2D 节点时返回 true（H5 或小程序 Canvas 2D）\n      return !!(this._canvasNode && typeof this._canvasNode.getContext === 'function')\n    }\n  }\n}\n</script>\n\n<style lang=\"scss\" scoped>\n.page { \n  min-height: 100vh; \n  display: flex; \n  flex-direction: column; \n  background: #fff; \n  /* 安全区域适配 */\n  padding-top: constant(safe-area-inset-top);\n  padding-top: env(safe-area-inset-top);\n  padding-bottom: constant(safe-area-inset-bottom);\n  padding-bottom: env(safe-area-inset-bottom);\n  /* 手动设置安全区域 */\n  padding-top: 35px;\n  padding-bottom: 15px;\n  box-sizing: border-box;\n}\n\n.hd { \n  font-size: 36rpx; \n  font-weight: 700; \n  padding: 24rpx; \n  text-align: center;\n  background: #f8f9fa;\n  border-bottom: 1rpx solid #e5e6eb;\n}\n\n.list { \n  flex: 1; \n  min-height: 0; \n  padding: 0 24rpx; \n  max-height: 300rpx;\n  overflow-y: auto;\n}\n\n.item { \n  padding: 20rpx 0; \n  border-bottom: 1rpx solid #f0f0f0; \n}\n\n.title { \n  font-weight: 600; \n  font-size: 30rpx; \n  margin-bottom: 8rpx; \n}\n\n.meta { \n  color: #666; \n  display: flex; \n  align-items: center; \n  gap: 16rpx; \n  flex-wrap: wrap; \n  font-size: 24rpx;\n}\n\n.tag { \n  color: #fff; \n  padding: 4rpx 12rpx; \n  border-radius: 16rpx;\n  font-size: 22rpx;\n  \n  &.inbound { background: #52c41a; }\n  &.outbound { background: #ff4d4f; }\n}\n\n.empty { \n  padding: 80rpx 0; \n}\n\n.section-title { \n  padding: 16rpx 24rpx; \n  font-weight: 600; \n  font-size: 28rpx;\n  color: #333;\n}\n\n.h-scroll {\n  white-space: nowrap;\n  padding: 0 24rpx 16rpx;\n}\n\n.chips {\n  display: flex;\n  gap: 12rpx;\n}\n\n.chip {\n  display: inline-flex;\n  align-items: center;\n  padding: 12rpx 20rpx;\n  background: #f6f7f9;\n  border-radius: 20rpx;\n  font-size: 26rpx;\n  color: #666;\n  white-space: nowrap;\n  border: 1rpx solid transparent;\n  \n  &.active {\n    background: #e6f7ff;\n    color: #1890ff;\n    border-color: #1890ff;\n  }\n  \n  radio {\n    margin-right: 8rpx;\n  }\n}\n\n.sign-wrap { \n  padding: 0 24rpx 12rpx; \n}\n\n.sign-canvas { \n  width: 100%; \n  background: #f7f8fa; \n  border-radius: 12rpx; \n  border: 2rpx dashed #d9d9d9; \n  touch-action: none; \n  -ms-touch-action: none; \n}\n\n.sign-tips {\n  text-align: center;\n  color: #999;\n  font-size: 24rpx;\n  margin-top: 12rpx;\n}\n\n.sign-status {\n  text-align: center;\n  color: #52c41a;\n  font-size: 26rpx;\n  margin-top: 12rpx;\n  font-weight: 600;\n}\n\n.footer { \n  padding: 12rpx 24rpx 24rpx; \n  background: #fff;\n  border-top: 1rpx solid #f0f0f0;\n}\n\n.btn-row {\n  display: flex;\n  gap: 12rpx;\n  justify-content: space-between;\n}\n\n.action-btn {\n  flex: 1;\n  height: 88rpx;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  border-radius: 12rpx;\n  font-size: 28rpx;\n  font-weight: 600;\n  color: #fff;\n}\n\n.btn-cancel {\n  background: #ff4d4f;\n}\n\n.btn-clear {\n  background: #faad14;\n}\n\n.btn-confirm {\n  background: #52c41a;\n}\n\n.btn-settle {\n  background: #1890ff;\n}\n\n.btn-disabled {\n  background: #d9d9d9 !important;\n  color: #999 !important;\n}\n\n/* 移动端响应式样式 */\n@media screen and (max-width: 480px) {\n  .hd {\n    font-size: 32rpx;\n    padding: 20rpx;\n  }\n  \n  .list {\n    padding: 0 20rpx;\n    max-height: 250rpx;\n  }\n  \n  .title {\n    font-size: 28rpx;\n  }\n  \n  .meta {\n    font-size: 24rpx;\n  }\n  \n  .section-title {\n    font-size: 28rpx;\n    padding: 20rpx;\n  }\n  \n  .chip {\n    padding: 12rpx 20rpx;\n    font-size: 24rpx;\n    margin-right: 16rpx;\n  }\n  \n  .btn-group {\n    padding: 20rpx;\n    gap: 16rpx;\n  }\n  \n  .btn {\n    height: 80rpx;\n    font-size: 28rpx;\n  }\n}\n\n@media screen and (max-width: 375px) {\n  .hd {\n    font-size: 30rpx;\n    padding: 16rpx;\n  }\n  \n  .list {\n    padding: 0 16rpx;\n    max-height: 200rpx;\n  }\n  \n  .title {\n    font-size: 26rpx;\n  }\n  \n  .meta {\n    font-size: 22rpx;\n  }\n  \n  .section-title {\n    font-size: 26rpx;\n    padding: 16rpx;\n  }\n  \n  .chip {\n    padding: 10rpx 16rpx;\n    font-size: 22rpx;\n    margin-right: 12rpx;\n  }\n  \n  .btn-group {\n    padding: 16rpx;\n    gap: 12rpx;\n  }\n  \n  .btn {\n    height: 75rpx;\n    font-size: 26rpx;\n  }\n}\n\n/* 横屏适配 */\n@media screen and (orientation: landscape) and (max-height: 500px) {\n  .page {\n    padding-top: 20px;\n    padding-bottom: 10px;\n  }\n  \n  .hd {\n    padding: 16rpx;\n  }\n  \n  .list {\n    max-height: 150rpx;\n  }\n  \n  .section-title {\n    padding: 16rpx;\n  }\n  \n  .btn-group {\n    padding: 16rpx;\n  }\n}\n</style>\n","import mod from \"-!D:\\\\Program Files\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\mini-css-extract-plugin\\\\dist\\\\loader.js??ref--8-oneOf-1-0!D:\\\\Program Files\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\css-loader\\\\dist\\\\cjs.js??ref--8-oneOf-1-1!D:\\\\Program Files\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\vue-cli-plugin-uni\\\\packages\\\\vue-loader\\\\lib\\\\loaders\\\\stylePostLoader.js!D:\\\\Program Files\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\vue-cli-plugin-uni\\\\packages\\\\webpack-preprocess-loader\\\\index.js??ref--8-oneOf-1-2!D:\\\\Program Files\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\postcss-loader\\\\src\\\\index.js??ref--8-oneOf-1-3!D:\\\\Program Files\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\vue-cli-plugin-uni\\\\packages\\\\sass-loader\\\\dist\\\\cjs.js??ref--8-oneOf-1-4!D:\\\\Program Files\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\vue-cli-plugin-uni\\\\packages\\\\webpack-preprocess-loader\\\\index.js??ref--8-oneOf-1-5!D:\\\\Program Files\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\vue-cli-plugin-uni\\\\packages\\\\vue-loader\\\\lib\\\\index.js??vue-loader-options!D:\\\\Program Files\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\webpack-uni-mp-loader\\\\lib\\\\style.js!./checkout.vue?vue&type=style&index=0&id=a037f574&lang=scss&scoped=true&\"; export default mod; export * from \"-!D:\\\\Program Files\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\mini-css-extract-plugin\\\\dist\\\\loader.js??ref--8-oneOf-1-0!D:\\\\Program Files\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\css-loader\\\\dist\\\\cjs.js??ref--8-oneOf-1-1!D:\\\\Program Files\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\vue-cli-plugin-uni\\\\packages\\\\vue-loader\\\\lib\\\\loaders\\\\stylePostLoader.js!D:\\\\Program Files\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\vue-cli-plugin-uni\\\\packages\\\\webpack-preprocess-loader\\\\index.js??ref--8-oneOf-1-2!D:\\\\Program Files\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\postcss-loader\\\\src\\\\index.js??ref--8-oneOf-1-3!D:\\\\Program Files\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\vue-cli-plugin-uni\\\\packages\\\\sass-loader\\\\dist\\\\cjs.js??ref--8-oneOf-1-4!D:\\\\Program Files\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\vue-cli-plugin-uni\\\\packages\\\\webpack-preprocess-loader\\\\index.js??ref--8-oneOf-1-5!D:\\\\Program Files\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\vue-cli-plugin-uni\\\\packages\\\\vue-loader\\\\lib\\\\index.js??vue-loader-options!D:\\\\Program Files\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\webpack-uni-mp-loader\\\\lib\\\\style.js!./checkout.vue?vue&type=style&index=0&id=a037f574&lang=scss&scoped=true&\"","// extracted by mini-css-extract-plugin\n    if(module.hot) {\n      // 1763277929086\n      var cssReload = require(\"D:/Program Files/HBuilderX/plugins/uniapp-cli/node_modules/mini-css-extract-plugin/dist/hmr/hotModuleReplacement.js\")(module.id, {\"hmr\":true,\"publicPath\":\"/\",\"locals\":false});\n      module.hot.dispose(cssReload);\n      module.hot.accept(undefined, cssReload);\n    }\n  "],"sourceRoot":""}